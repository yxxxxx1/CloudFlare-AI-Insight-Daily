name: Auto Build AI Daily & Deploy Pro Website

on:
  workflow_dispatch: {}
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ 08:10 è¿è¡Œï¼ˆUTC 00:10ï¼‰
    - cron: "10 0 * * *"

jobs:
  auto-daily:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        # [ä¼˜åŒ–] æ·»åŠ  fetch-depth: 0 ä»¥ä¾¿ Hugo/Hextra èƒ½è·å–æ‰€æœ‰ .md å†å²
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # --- [ç¬¬ 1 éƒ¨åˆ†ï¼šæ ¸å¿ƒæ—¥æŠ¥ç”Ÿæˆ - é€»è¾‘ä¿®å¤] ---
      - name: Run end-to-end pipeline (login â†’ writeData â†’ genAI â†’ writeFiles â†’ rss)
        env:
          BASE_URL: ${{ vars.WORKER_BASE_URL }}
          USERNAME: ${{ secrets.WORKER_LOGIN_USERNAME }}
          PASSWORD: ${{ secrets.WORKER_LOGIN_PASSWORD }}
          FOLO_COOKIE_SECRET: ${{ secrets.CF_FOLO_COOKIE }}
          MAX_PER_TYPE: "6"
          TZ: Asia/Shanghai
        run: |
          node - <<'EOF'
          // [FINAL v22 ä¿®å¤] åˆ‡æ¢åˆ° async function main() ç»“æ„
          
          // -------- helpers ----------
          // [ä¿®å¤] ä½¿ç”¨ require ä»£æ›¿ await import
          const fs = require('fs').promises;
          const path = require('path');
          
          const BASE = process.env.BASE_URL.replace(/\/+$/, '');
          const DATE = new Date(Date.now() + 8*3600*1000).toISOString().slice(0,10); // GMT+8 yyy-mm-dd
          const MAX_PER_TYPE = Number(process.env.MAX_PER_TYPE || 6);

          let cookieJar = '';
          const keepCookie = (res) => {
            const set = res.headers.get('set-cookie');
            if (set) {
              const one = set.split(',')[0];
              const m = one.match(/^[^;]+/);
              if (m) {
                cookieJar = cookieJar ? (cookieJar + '; ' + m[0]) : m[0];
              }
            }
            return cookieJar;
          };

          const fetchWithCookie = async (url, opts={}) => {
            const headers = Object.assign({}, opts.headers || {});
            if (cookieJar) headers['cookie'] = cookieJar;
            const res = await fetch(url, {...opts, headers});
            keepCookie(res);
            return res;
          };

          const ok = (res) => {
            if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
          };

          const form = (pairs) => {
            const fd = new FormData();
            for (const [k,v] of pairs) {
              if (Array.isArray(v)) v.forEach(x=>fd.append(k, x));
              else fd.append(k, v);
            }
            return fd;
          };
          
          // [FINAL v22 ä¿®å¤] å°†æ‰€æœ‰é€»è¾‘æ”¾å…¥ async main()
          async function main() {
            console.log(`BASE: ${BASE}`);
            console.log(`DATE: ${DATE}`);

            // 1) login è·å– cookie
            console.log('ğŸ” Login ...');
            {
              const fd = new URLSearchParams();
              fd.set('username', process.env.USERNAME);
              fd.set('password', process.env.PASSWORD);
              const res = await fetch(`${BASE}/login`, {
                method: 'POST',
                headers: { 'content-type': 'application/x-www-form-urlencoded' },
                redirect: 'manual',
                body: fd.toString()
              });
              if (res.status !== 200 && res.status !== 302) {
                throw new Error(`Login failed: HTTP ${res.status}`);
              }
              keepCookie(res);
              if (!cookieJar) throw new Error('No cookie returned from login');
            }
            console.log('âœ… Login OK');

            // 2) writeData
            console.log('ğŸ“ writeData ...');
            {
              const res = await fetchWithCookie(`${BASE}/writeData`, {
                method: 'POST',
                headers: { 'content-type': 'application/json' },
                body: JSON.stringify({ foloCookie: process.env.FOLO_COOKIE_SECRET })
              });
              ok(res);
              const j = await res.json().catch(()=>({}));
              console.log('writeData result:', j);
            }

            // 3) getContent
            console.log('ğŸ“¥ getContent ...');
            const all = {};
            {
              const res = await fetch(`${BASE}/getContent?date=${DATE}`);
              ok(res);
              const j = await res.json();
              for (const [k,v] of Object.entries(j)) {
                if (Array.isArray(v)) all[k] = v;
              }
              console.log('got categories:', Object.keys(all));
            }

            // 4) æ„é€  selectedItems
            console.log('ğŸ§© build selectedItems ...');
            const selectedItems = [];
            for (const [type, arr] of Object.entries(all)) {
              for (const it of (arr || []).slice(0, MAX_PER_TYPE)) {
                if (it && (it.id !== undefined && it.id !== null)) {
                  selectedItems.push(`${type}:${it.id}`);
                }
              }
            }
            if (selectedItems.length === 0) throw new Error('No items to select â€“ writeData may have fetched nothing.');

            // 5) genAIContentï¼ˆJSON æ¨¡å¼ï¼‰
            console.log('ğŸ¤– genAIContent (JSON mode)...');
            let markdown = '';
            {
              const fd = form([
                ['date', DATE],
                ['selectedItems', selectedItems]
              ]);

              const res = await fetchWithCookie(`${BASE}/genAIContent?mode=json`, {
                method: 'POST',
                body: fd
              });
              ok(res);

              const j = await res.json().catch(() => null);
              if (!j || !j.markdown) {
                console.error('Full response:', j);
                throw new Error('genAIContent JSON response invalid or missing markdown field.');
              }

              markdown = j.markdown;
              if (!markdown.trim()) throw new Error('Empty markdown in genAIContent JSON result.');
            }
            console.log(`âœ… genAIContent OK (JSON mode, length=${markdown.length})`);

            // 6) [FINAL v19 é€»è¾‘ä¿®å¤] åœ¨æœ¬åœ°å†™å…¥ .md æ–‡ä»¶ (å¹¶æ·»åŠ  Hugo Front Matter)
            console.log('âœï¸ Writing .md file locally with Hugo Front Matter...');
            {
              // [ä¿®å¤] æ„é€  Hugo Front Matter
              // æˆ‘ä»¬ä½¿ç”¨ DATE (e.g., "2025-01-01") ä½œä¸º title å’Œ date
              const frontMatter = `---
title: "AI æ—¥æŠ¥ ${DATE}"
date: ${DATE}
---

`;
              
              const fileContent = frontMatter + markdown; // å°† Front Matter æ‹¼æ¥åˆ° Markdown å†…å®¹å‰

              const dailyDir = path.resolve(process.cwd(), 'daily');
              await fs.mkdir(dailyDir, { recursive: true }); // ç¡®ä¿ 'daily' ç›®å½•å­˜åœ¨
              const filePath = path.join(dailyDir, `${DATE}.md`);
              await fs.writeFile(filePath, fileContent, 'utf8'); // å†™å…¥åŒ…å« Front Matter çš„å®Œæ•´å†…å®¹
              console.log(`âœ… File written to ${filePath}`);
            }

            // 7) writeRssData (åŸç¬¬7æ­¥)
            console.log('ğŸª„ writeRssData ...');
            {
              const res = await fetch(`${BASE}/writeRssData?date=${DATE}`, { redirect: 'follow' });
              ok(res);
              const j = await res.json().catch(()=>({}));
              console.log('writeRssData result:', j.title || j.report_date || 'OK');
            }

            // 8) ä¸‹è½½ RSS åˆ°æœ¬åœ° (åŸç¬¬8æ­¥)
            console.log('â¬‡ï¸ download RSS ...');
            {
              const res = await fetch(`${BASE}/rss?days=7`);
              ok(res);
              const xml = await res.text();
              await fs.writeFile('rss.xml', xml, 'utf8');
              console.log('âœ… File written to rss.xml');
            }

            console.log('ğŸ‰ All done for', DATE);
          }
          
          // [FINAL v22 ä¿®å¤] æ‰§è¡Œ main å‡½æ•°å¹¶å¤„ç†é”™è¯¯
          main().catch(e => {
            console.error(e);
            process.exit(1);
          });
  EOF

      # --- [ç¬¬ 2 éƒ¨åˆ†ï¼šæäº¤ RSS å’Œ .md æ–‡ä»¶ - é€»è¾‘ä¿®å¤] ---
      - name: Commit and push changes (rss.xml and daily/*.md)
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # [FINAL v19 ä¿®å¤] æ·»åŠ æ‰€æœ‰æ–°æ–‡ä»¶ (rss.xml å’Œ daily/YYYY-MM-DD.md)
          git add rss.xml
          git add daily/

          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "docs: auto-build AI Daily ($(date -u))"
            # [ä¿®å¤] æ‹‰å–è¿œç¨‹æ›´æ–°ç°åœ¨æ˜¯å®‰å…¨çš„
            git pull --rebase origin main || true
            git push origin main
          fi

      # --- [ç¬¬ 3 éƒ¨åˆ†ï¼šæ„å»ºä¸“ä¸šç½‘ç«™ - æ›¿æ¢åŸæœ‰çš„éƒ¨ç½²æ­¥éª¤] ---
      - name: Install Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: 'latest'
          # [æœ€ç»ˆä¿®å¤] å¿…é¡»ä½¿ç”¨ extended ç‰ˆ
          extended: true 

      # --- [FINAL v19 ä¿®å¤] åˆ é™¤äº†ä½  baseline ä¸­æ— æ•ˆçš„ "Setup Hugo Theme" æ­¥éª¤ ---
      
      - name: Build Website with Hugo
        run: |
          echo "Initializing Hugo Module..."
          # ä½¿ç”¨ GITHUB_REPOSITORY (ä¾‹å¦‚ "yxxxxx1/CloudFlare-AI-Insight-Daily") ä½œä¸ºæ¨¡å—å
          hugo mod init github.com/${{ github.REPOSITORY }}

          echo "Creating Hugo configuration..."
          # åŠ¨æ€åˆ›å»º Hugo é…ç½®æ–‡ä»¶
          
          # â–¼â–¼â–¼ [é‡è¦] è¯·å°† baseURL ä¿®æ”¹ä¸ºä½ çš„ GitHub Pages ç½‘å€ â–¼â–¼â–¼
          cat << EOF > hugo.toml
          baseURL = "https://yxxxxx1.github.io/CloudFlare-AI-Insight-Daily/"
          languageCode = "zh-cn"
          title = "AI èµ„è®¯æ—¥æŠ¥"
          
          # [æœ€ç»ˆä¿®å¤] æ˜ç¡®å¯¼å…¥ Hextra ä¸»é¢˜
          [module]
            [[module.imports]]
              path = "github.com/imfing/hextra"

          # å…è®¸é¦–é¡µæ¸²æŸ“ HTML å’Œæ¨¡æ¿é€»è¾‘
          [outputs]
            home = ["HTML", "RSS", "JSON"]

          # Hextra ä¸»é¢˜çš„é…ç½®
          [params]
            [params.theme]
              # å¼€å¯æš—é»‘/æ˜äº®æ¨¡å¼è‡ªåŠ¨åˆ‡æ¢
              mode = "auto"
              toggle = true
          
          # é…ç½®èœå•
          [menu]
            [[menu.main]]
              name = "é¦–é¡µ"
              url = "/"
              weight = 1
            [[menu.main]]
              name = "æ—¥æŠ¥"  # æ—¥æŠ¥ç›®å½•é“¾æ¥
              url = "/daily"
              weight = 2
            [[menu.main]]
              name = "RSS"
              url = "/rss.xml"
              weight = 3
            [[menu.main]]
              name = "GitHub"
              url = "https://github.com/yxxxxx1/CloudFlare-AI-Insight-Daily"
              weight = 4
          EOF

          echo "Configuring Git for Hugo Modules..."
          # [æœ€ç»ˆä¿®å¤] è§£å†³ 'terminal prompts disabled' é”™è¯¯
          git config --global url."https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"

          echo "Tidying Hugo modules (Hextra)..."
          # è¿è¡Œ 'hugo mod tidy' ä¼šè‡ªåŠ¨ä¸‹è½½ hextra åŠå…¶æ‰€æœ‰ä¾èµ–ï¼ˆåŒ…æ‹¬ shortcodesï¼‰
          hugo mod tidy

          echo "Organizing content for Hugo..."
          # 1. æŠŠæ‰€æœ‰æ—¥æŠ¥ .md ç§»åŠ¨åˆ° Hugo çš„ content ç›®å½•
          mkdir -p content/daily
          # [é‡è¦] ç¡®ä¿ daily ç›®å½•å­˜åœ¨ï¼Œå¦åˆ™ cp ä¼šå¤±è´¥
          if [ -d "daily" ]; then
            cp -r daily/*.md content/daily/
          else
            echo "Warning: 'daily' directory not found. No posts to build."
          fi

          # 2. æŠŠ rss.xml ç§»åŠ¨åˆ° static ç›®å½•
          mkdir -p static
          if [ -f "rss.xml" ]; then
            cp rss.xml static/
          fi

          # 3. åˆ›å»ºä¸€ä¸ªåŠ¨æ€é¦–é¡µ (ä» .md æ”¹ä¸º .html æ¥æ‰§è¡Œæ¨¡æ¿)
          # [v17 YAML ä¿®å¤] è½¬ä¹‰æ‰€æœ‰ {{ å’Œ }}
          cat << EOF > content/_index.html
          ---
          title: "AI èµ„è®¯æ—¥æŠ¥"
          type: "page"
          ---
          
          <div class="mt-6">
            æ¬¢è¿æ¥åˆ° AI èµ„è®¯æ—¥æŠ¥ã€‚
            <br>
            è¿™é‡Œæ¯æ—¥ä¸ºæ‚¨ç²¾é€‰ AI é¢†åŸŸçš„æœ€æ–°åŠ¨æ€ï¼ŒåŒ…æ‹¬è¡Œä¸šæ–°é—»ã€çƒ­é—¨å¼€æºé¡¹ç›®ã€å‰æ²¿å­¦æœ¯è®ºæ–‡å’Œç§‘æŠ€å¤§Vç¤¾äº¤åª’ä½“è¨€è®ºã€‚
          </div>

          <h2 class="mt-8">æœ€è¿‘æ—¥æŠ¥</h2>

          ${{ '{{' }}< list-container >}} <!-- [æœ€ç»ˆä¿®å¤] ç§»é™¤äº† 'hextra/' å‰ç¼€ -->
          ${{ '{{' }}/* æŸ¥è¯¢ daily åˆ†åŒºä¸­çš„æ‰€æœ‰é¡µé¢ï¼ŒæŒ‰æ–‡ä»¶åï¼ˆå³æ—¥æœŸï¼‰å€’åºï¼Œå–å‰ 7 ç¯‡ */}}
          ${{ '{{' }} range first 7 (where .Site.RegularPages "Section" "daily" | sort .File.Path ".md" "desc") }}
            <a href="${{ '{{' }} .RelPermalink }}" class="flex !no-underline my-4">
              <div class="flex-1">
                <div class="font-semibold">${{ '{{' }} .Title }}</div>
                <div class="text-sm text-gray-500 dark:text-gray-400">
                  ${{ '{{' }} .Date.Format "2006-01-02" }}
                </div>
              </div>
            </a>
          ${{ '{{' }} end }}
          ${{ '{{' }}< /list-container >}} <!-- [æœ€ç»ˆä¿®å¤] ç§»é™¤äº† 'hextra/' å‰ç¼€ -->

          <a href="/daily" class="mt-4 inline-block">æŸ¥çœ‹æ‰€æœ‰æ—¥æŠ¥ â†’</a>
          EOF

          # 4. ä¸º /daily åˆ—è¡¨é¡µåˆ›å»ºä¸€ä¸ª _index.html
          # [v17 YAML ä¿®å¤] è½¬ä¹‰æ‰€æœ‰ {{ å’Œ }}
          cat << EOF > content/daily/_index.html
          ---
          title: "æ‰€æœ‰æ—¥æŠ¥"
          type: "page"
          ---

          <h1>æ‰€æœ‰æ—¥æŠ¥</h1>

          ${{ '{{' }}< list-container >}} <!-- [æœ€ç»ˆä¿®å¤] ç§»é™¤äº† 'hextra/' å‰ç¼€ -->
          ${{ '{{' }}/* éå† .Pages (å³ daily ç›®å½•ä¸‹çš„æ‰€æœ‰é¡µé¢), æŒ‰æ—¥æœŸå€’åº */}}
          ${{ '{{' }} range .Pages.ByDate.Reverse }}
            <a href="${{ '{{' }} .RelPermalink }}" class="flex !no-underline my-4">
              <div class="flex-1">
                <div class="font-semibold">${{ '{{' }} .Title }}</div>
                <div class="text-sm text-gray-500 dark:text-gray-400">
                  ${{ '{{' }} .Date.Format "2006-01-02" }}
                </div>
              </div>
            </a>
          ${{ '{{' }} end }}
          ${{ '{{' }}< /list-container >}} <!-- [æœ€ç»ˆä¿®å¤] ç§»é™¤äº† 'hextra/' å‰ç¼€ -->
          
          echo "Running Hugo build..."
          # 5. è¿è¡Œ Hugo æ„å»º
          hugo

      # --- [ç¬¬ 4 éƒ¨åˆ†ï¼šéƒ¨ç½²åˆ° gh-pages åˆ†æ”¯ - ä½ çš„åŸå§‹ä»£ç ï¼Œå®Œå…¨ä¸å˜] ---
      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # æŒ‡å®š Hugo çš„è¾“å‡ºç›®å½•
          publish_dir: ./public
          # ç¡®ä¿æ¨é€åˆ° gh-pages åˆ†æ”¯
          publish_branch: gh-pages
          # æ¯æ¬¡éƒ½å¼ºåˆ¶æ¨é€ï¼Œè¦†ç›–æ—§çš„æ„å»º
          force_orphan: true
