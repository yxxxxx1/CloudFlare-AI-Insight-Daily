name: Auto Build AI Daily & Deploy Pro Website

on:
  workflow_dispatch: {}
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ 08:10 è¿è¡Œï¼ˆUTC 00:10ï¼‰
    - cron: "10 0 * * *"

jobs:
  auto-daily:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        # [ä¼˜åŒ–] æ·»åŠ  fetch-depth: 0 ä»¥ä¾¿ Hugo/Hextra èƒ½è·å–æ‰€æœ‰ .md å†å²
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # --- [ç¬¬ 1 éƒ¨åˆ†ï¼šæ ¸å¿ƒæ—¥æŠ¥ç”Ÿæˆ - ä½ çš„åŸå§‹ä»£ç ï¼Œå®Œå…¨ä¸å˜] ---
      - name: Run end-to-end pipeline (login â†’ writeData â†’ genAI â†’ commit â†’ writeRssData â†’ rss)
        env:
          BASE_URL: ${{ vars.WORKER_BASE_URL }}
          USERNAME: ${{ secrets.WORKER_LOGIN_USERNAME }}
          PASSWORD: ${{ secrets.WORKER_LOGIN_PASSWORD }}
          FOLO_COOKIE_SECRET: ${{ secrets.CF_FOLO_COOKIE }}
          MAX_PER_TYPE: "6"
          TZ: Asia/Shanghai
        run: |
          node - <<'EOF'
          // -------- helpers ----------
          const BASE = process.env.BASE_URL.replace(/\/+$/, '');
          const DATE = new Date(Date.now() + 8*3600*1000).toISOString().slice(0,10); // GMT+8 yyyy-mm-dd
          const MAX_PER_TYPE = Number(process.env.MAX_PER_TYPE || 6);

          let cookieJar = '';
          const keepCookie = (res) => {
            const set = res.headers.get('set-cookie');
            if (set) {
              const one = set.split(',')[0];
              const m = one.match(/^[^;]+/);
              if (m) {
                cookieJar = cookieJar ? (cookieJar + '; ' + m[0]) : m[0];
              }
            }
            return cookieJar;
          };

          const fetchWithCookie = async (url, opts={}) => {
            const headers = Object.assign({}, opts.headers || {});
            if (cookieJar) headers['cookie'] = cookieJar;
            const res = await fetch(url, {...opts, headers});
            keepCookie(res);
            return res;
          };

          const ok = (res) => {
            if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
          };

          const form = (pairs) => {
            const fd = new FormData();
            for (const [k,v] of pairs) {
              if (Array.isArray(v)) v.forEach(x=>fd.append(k, x));
              else fd.append(k, v);
            }
            return fd;
          };

          console.log(`BASE: ${BASE}`);
          console.log(`DATE: ${DATE}`);

          // 1) login è·å– cookie
          console.log('ğŸ” Login ...');
          {
            const fd = new URLSearchParams();
            fd.set('username', process.env.USERNAME);
            fd.set('password', process.env.PASSWORD);
            const res = await fetch(`${BASE}/login`, {
              method: 'POST',
              headers: { 'content-type': 'application/x-www-form-urlencoded' },
              redirect: 'manual',
              body: fd.toString()
            });
            if (res.status !== 200 && res.status !== 302) {
              throw new Error(`Login failed: HTTP ${res.status}`);
            }
            keepCookie(res);
            if (!cookieJar) throw new Error('No cookie returned from login');
          }
          console.log('âœ… Login OK');

          // 2) writeData
          console.log('ğŸ“ writeData ...');
          {
            const res = await fetchWithCookie(`${BASE}/writeData`, {
              method: 'POST',
              headers: { 'content-type': 'application/json' },
              body: JSON.stringify({ foloCookie: process.env.FOLO_COOKIE_SECRET })
            });
            ok(res);
            const j = await res.json().catch(()=>({}));
            console.log('writeData result:', j);
          }

          // 3) getContent
          console.log('ğŸ“¥ getContent ...');
          const all = {};
          {
            const res = await fetch(`${BASE}/getContent?date=${DATE}`);
            ok(res);
            const j = await res.json();
            for (const [k,v] of Object.entries(j)) {
              if (Array.isArray(v)) all[k] = v;
            }
            console.log('got categories:', Object.keys(all));
          }

          // 4) æ„é€  selectedItems
          console.log('ğŸ§© build selectedItems ...');
          const selectedItems = [];
          for (const [type, arr] of Object.entries(all)) {
            for (const it of (arr || []).slice(0, MAX_PER_TYPE)) {
              if (it && (it.id !== undefined && it.id !== null)) {
                selectedItems.push(`${type}:${it.id}`);
              }
            }
          }
          if (selectedItems.length === 0) throw new Error('No items to select â€“ writeData may have fetched nothing.');

          // 5) genAIContentï¼ˆJSON æ¨¡å¼ï¼‰
          console.log('ğŸ¤– genAIContent (JSON mode)...');
          let markdown = '';
          {
            const fd = form([
              ['date', DATE],
              ['selectedItems', selectedItems]
            ]);

            const res = await fetchWithCookie(`${BASE}/genAIContent?mode=json`, {
              method: 'POST',
              body: fd
            });
            ok(res);

            const j = await res.json().catch(() => null);
            if (!j || !j.markdown) {
              console.error('Full response:', j);
              throw new Error('genAIContent JSON response invalid or missing markdown field.');
            }

            markdown = j.markdown;
            if (!markdown.trim()) throw new Error('Empty markdown in genAIContent JSON result.');
          }
          console.log(`âœ… genAIContent OK (JSON mode, length=${markdown.length})`);

          // 6) commitToGitHub
          console.log('â¬†ï¸ commitToGitHub ...');
          {
            const fd = form([
              ['date', DATE],
              ['daily_summary_markdown', markdown]
            ]);
            const res = await fetchWithCookie(`${BASE}/commitToGitHub`, {
              method: 'POST',
              body: fd
            });
            ok(res);
            const j = await res.json().catch(()=>({}));
            console.log('commitToGitHub result:', j);
          }

          // 7) writeRssData
          console.log('ğŸª„ writeRssData ...');
          {
            const res = await fetch(`${BASE}/writeRssData?date=${DATE}`, { redirect: 'follow' });
            ok(res);
            const j = await res.json().catch(()=>({}));
            console.log('writeRssData result:', j.title || j.report_date || 'OK');
          }

          // 8) ä¸‹è½½ RSS åˆ°æœ¬åœ°
          console.log('â¬‡ï¸ download RSS ...');
          {
            const res = await fetch(`${BASE}/rss?days=7`);
            ok(res);
            const xml = await res.text();
            const fs = await import('node:fs/promises');
            await fs.writeFile('rss.xml', xml, 'utf8');
          }

          console.log('ğŸ‰ All done for', DATE);
          EOF

      # --- [ç¬¬ 2 éƒ¨åˆ†ï¼šæäº¤ RSS å¹¶æ‹‰å–æœ€æ–° MD - ä½ çš„åŸå§‹ä»£ç ï¼Œå®Œå…¨ä¸å˜] ---
      # (è¿™ä¸ªæ­¥éª¤ä¼šæ‹‰å– Worker æäº¤çš„ .md æ–‡ä»¶ï¼Œå¹¶æäº¤ rss.xml)
      - name: Commit and push changes (rss.xml)
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          if [ -f "rss.xml" ]; then
            git add rss.xml
          fi

          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "docs: auto-build AI Daily ($(date -u))"
            # å…ˆæ‹‰å–è¿œç¨‹æ›´æ–°å†æ¨é€ï¼Œé˜²æ­¢ fetch first å†²çª
            # è¿™ä¸€æ­¥ä¼šæ‹‰å–ç¬¬ 1 éƒ¨åˆ†ä¸­ Worker æäº¤çš„ .md æ–‡ä»¶
            git pull --rebase origin main || true
            git push origin main
          fi

      # --- [ç¬¬ 3 éƒ¨åˆ†ï¼šæ„å»ºä¸“ä¸šç½‘ç«™ - æ›¿æ¢åŸæœ‰çš„éƒ¨ç½²æ­¥éª¤] ---
      - name: Install Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: 'latest'

      - name: Setup Hugo Theme (Hextra)
        run: |
          echo "Cloning Hextra theme..."
          mkdir -p themes
          # ä½¿ç”¨ Git Submodule æ¥å®‰è£…ä¸»é¢˜
          git submodule add -f https://github.com/imfing/hextra.git themes/hextra

      - name: Build Website with Hugo
        run: |
          echo "Creating Hugo configuration..."
          # åŠ¨æ€åˆ›å»º Hugo é…ç½®æ–‡ä»¶
          cat << EOF > hugo.toml
          baseURL = "https://yxxxxx1.github.io/CloudFlare-AI-Insight-Daily/"
          languageCode = "zh-cn"
          title = "AI èµ„è®¯æ—¥æŠ¥"
          theme = "hextra"

          [params]
            [params.theme]
              mode = "auto"
              toggle = true
          
          # --- â–¼â–¼â–¼ã€æ·»åŠ â€œå†å²æ—¥æŠ¥â€èœå•é¡¹ã€‘â–¼â–¼â–¼ ---
          [menu]
            [[menu.main]]
              name = "å†å²æ—¥æŠ¥"
              url = "/daily"
              weight = 0 # æ”¾åœ¨æœ€å‰é¢
            [[menu.main]]
              name = "RSS"
              url = "/rss.xml"
              weight = 1
            [[menu.main]]
              name = "GitHub"
              url = "https://github.com/yxxxxx1/CloudFlare-AI-Insight-Daily"
              weight = 2
          EOF

          echo "Organizing content for Hugo..."
          # 1. ç»„ç»‡å†…å®¹
          mkdir -p content/daily
          cp -r daily/*.md content/daily/
          mkdir -p static
          cp rss.xml static/
          
          # 2. åˆ›å»ºé¦–é¡µ
          cat << EOF > content/_index.md
          ---
          title: "AI èµ„è®¯æ—¥æŠ¥"
          type: "page"
          ---

          æ¬¢è¿æ¥åˆ° AI èµ„è®¯æ—¥æŠ¥ã€‚

          è¿™é‡Œæ¯æ—¥ä¸ºæ‚¨ç²¾é€‰ AI é¢†åŸŸçš„æœ€æ–°åŠ¨æ€ï¼ŒåŒ…æ‹¬è¡Œä¸šæ–°é—»ã€çƒ­é—¨å¼€æºé¡¹ç›®ã€å‰æ²¿å­¦æœ¯è®ºæ–‡å’Œç§‘æŠ€å¤§Vç¤¾äº¤åª’ä½“è¨€è®ºã€‚
          EOF
          
          # --- â–¼â–¼â–¼ã€åˆ›å»ºæ—¥æŠ¥åˆ—è¡¨é¡µã€‘â–¼â–¼â–¼ ---
          echo "Creating daily list page..."
          cat << EOF > content/daily/_index.md
          ---
          title: "å†å²æ—¥æŠ¥"
          type: "page" 
          ---

          è¿™é‡Œæ˜¯æ‰€æœ‰çš„å†å²æ—¥æŠ¥å­˜æ¡£ã€‚
          EOF
          # --- â–²â–²â–²ã€åˆ—è¡¨é¡µç»“æŸã€‘â–²â–²â–² ---

          # --- â–¼â–¼â–¼ã€åˆå¹¶åçš„æœ€ç»ˆä¿®å¤è„šæœ¬ã€‘â–¼â–¼â–¼ ---
          echo "Fixing missing Front Matter for Hugo..."
          for file in content/daily/*.md; do
            # æˆ‘ä»¬åªå¤„ç†æ–‡ä»¶ï¼Œè·³è¿‡ _index.md
            if [[ "$file" == "content/daily/_index.md" ]]; then
              continue
            fi

            if [ "$(head -n 1 "$file")" != "---" ]; then
              echo "Adding Front Matter to $file"
              
              date_from_file=$(basename "$file" .md)
              title_from_file=$(head -n 1 "$file" | sed 's/^## //' | sed 's/[[:space:]]*$//')
              original_content=$(cat "$file")
              
              # ä¸€æ¬¡æ€§æ·»åŠ æ‰€æœ‰å¿…éœ€çš„ Front Matter
              (
                echo "---"
                echo "title: \"$title_from_file\""
                echo "date: $date_from_file"
                echo "type: \"page\"" # <-- çœŸæ­£è§£å†³è¿œå› çš„è¡Œ
                echo "---"
                echo ""
                echo "$original_content"
              ) > "$file"
            else
              echo "Skipping $file, Front Matter already exists."
            fi
          done
          # --- â–²â–²â–²ã€è„šæœ¬ç»“æŸã€‘â–²â–²â–² ---

          # --- â–¼â–¼â–¼ã€è°ƒè¯•è„šæœ¬ã€‘â–¼â–¼â–¼ ---
          echo "--- [DEBUG] æ£€æŸ¥ä¸€ä¸ª .md æ–‡ä»¶çš„å¤´éƒ¨å†…å®¹ (ä¿®å¤å) ---"
          find content/daily -name "*.md" -print0 | xargs -0 -I {} sh -c 'echo "--- Content of: {} ---"; cat "{}" | head -n 5'
          # --- â–²â–²â–²ã€è°ƒè¯•ç»“æŸã€‘â–²â–²â–² ---
          
          echo "Running Hugo build..."
          # 4. è¿è¡Œ Hugo æ„å»º
          hugo -v -D --buildFuture

      # --- [ç¬¬ 4 éƒ¨åˆ†ï¼šéƒ¨ç½²åˆ° gh-pages åˆ†æ”¯] ---
      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # æŒ‡å®š Hugo çš„è¾“å‡ºç›®å½•
          publish_dir: ./public
          # ç¡®ä¿æ¨é€åˆ° gh-pages åˆ†æ”¯
          publish_branch: gh-pages
          # æ¯æ¬¡éƒ½å¼ºåˆ¶æ¨é€ï¼Œè¦†ç›–æ—§çš„æ„å»º
          force_orphan: true
