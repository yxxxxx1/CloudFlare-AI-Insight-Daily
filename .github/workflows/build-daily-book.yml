name: Build Daily Journal

on:
  workflow_dispatch:    # å…è®¸æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: "0 1 * * *" # æ¯å¤© UTC 01:00 æ‰§è¡Œï¼ˆåŒ—äº¬æ—¶é—´ä¸Šåˆ 9 ç‚¹ï¼‰

jobs:
  build-book:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Archive old notes
        run: |
          echo "Archiving previous notes if needed..."
          mkdir -p archive
          # å¯åœ¨æ­¤æ·»åŠ å½’æ¡£é€»è¾‘ï¼ˆç›®å‰è·³è¿‡ï¼‰

      - name: Trigger RSS Data Write
        env:
          WRITE_RSS_URL: ${{ secrets.WRITE_RSS_URL }}
        run: |
          echo "Triggering RSS Data Write via Cloudflare Worker..."
          TODAY=$(date +'%Y-%m-%d')
          echo "ğŸ“… Today is $TODAY"
          RESPONSE=$(curl -s -w "%{http_code}" -o response.json "${WRITE_RSS_URL}?date=${TODAY}")
          STATUS=$(tail -n1 <<< "$RESPONSE")
          if [ "$STATUS" != "200" ]; then
            echo "âŒ RSS Data Write failed (HTTP $STATUS)"
            cat response.json
            exit 1
          fi
          echo "âœ… RSS Data Write succeeded"
          cat response.json

      - name: Download RSS Feed
        env:
          RSS_FEED_URL: ${{ secrets.RSS_FEED_URL }}
        run: |
          echo "Downloading latest RSS feed..."
          curl -s -o rss.xml "${RSS_FEED_URL}?days=7"
          echo "âœ… RSS Feed downloaded successfully"

      - name: Commit and push changes
        run: |
          echo "Committing generated files..."
          git add daily/ || echo "No daily directory found"
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git commit -m "Update daily report for $(date +'%Y-%m-%d')" || echo "No changes to commit"
          git push || echo "No changes pushed"

      - name: Complete job
        run: echo "ğŸ‰ Daily journal build process completed successfully."
