name: Auto Build AI Daily

on:
  workflow_dispatch: {}
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ 08:10 è¿è¡Œï¼ˆUTC 00:10ï¼‰
    - cron: "10 0 * * *"

jobs:
  auto-daily:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Run end-to-end pipeline (login â†’ writeData â†’ genAI â†’ commit â†’ writeRssData â†’ rss)
        env:
          BASE_URL: ${{ vars.WORKER_BASE_URL }}
          USERNAME: ${{ secrets.WORKER_LOGIN_USERNAME }}
          PASSWORD: ${{ secrets.WORKER_LOGIN_PASSWORD }}
          MAX_PER_TYPE: "6"             # æ¯ä¸ªç±»åˆ«æœ€å¤šé€‰å–çš„æ¡ç›®æ•°é‡ï¼Œå¯æŒ‰éœ€è°ƒæ•´
          TZ: Asia/Shanghai
        run: |
          node - <<'EOF'
          // -------- helpers ----------
          const BASE = process.env.BASE_URL.replace(/\/+$/, '');
          const DATE = new Date(Date.now() + 8*3600*1000).toISOString().slice(0,10); // GMT+8 yyyy-mm-dd
          const MAX_PER_TYPE = Number(process.env.MAX_PER_TYPE || 6);

          let cookieJar = '';
          const keepCookie = (res) => {
            const set = res.headers.get('set-cookie');
            if (set) {
              // å–ç¬¬ä¸€æ®µ cookieï¼›å¤šæ®µæ—¶ç®€å•æ‹¼ä¸Š
              const one = set.split(',')[0];
              const m = one.match(/^[^;]+/);
              if (m) {
                cookieJar = cookieJar ? (cookieJar + '; ' + m[0]) : m[0];
              }
            }
            return cookieJar;
          };

          const fetchWithCookie = async (url, opts={}) => {
            const headers = Object.assign({}, opts.headers || {});
            if (cookieJar) headers['cookie'] = cookieJar;
            const res = await fetch(url, {...opts, headers});
            keepCookie(res);
            return res;
          };

          const ok = (res) => {
            if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
          }

          const form = (pairs) => {
            const fd = new FormData();
            for (const [k,v] of pairs) {
              if (Array.isArray(v)) v.forEach(x=>fd.append(k, x));
              else fd.append(k, v);
            }
            return fd;
          };

          console.log(`BASE: ${BASE}`);
          console.log(`DATE: ${DATE}`);

          // 1) login è·å– cookie
          console.log('ğŸ” Login ...');
          {
            const fd = new URLSearchParams();
            fd.set('username', process.env.USERNAME);
            fd.set('password', process.env.PASSWORD);
            // login åä¼š 302 åˆ° redirectï¼ˆworkers é»˜è®¤å…è®¸ï¼‰
            const res = await fetch(`${BASE}/login`, {
              method: 'POST',
              headers: { 'content-type': 'application/x-www-form-urlencoded' },
              redirect: 'manual',
              body: fd.toString()
            });
            if (res.status !== 200 && res.status !== 302) {
              throw new Error(`Login failed: HTTP ${res.status}`);
            }
            keepCookie(res);
            if (!cookieJar) throw new Error('No cookie returned from login');
          }
          console.log('âœ… Login OK');

          // 2) writeDataï¼ˆæŠ“å–å½“å¤©å†…å®¹å†™å…¥ KVï¼‰
          console.log('ğŸ“ writeData ...');
          {
            const res = await fetchWithCookie(`${BASE}/writeData`, {
              method: 'POST',
              headers: { 'content-type': 'application/json' },
              body: JSON.stringify({})   // ä¸ä¼  category = æŠ“å–æ‰€æœ‰ç±»åˆ«
            });
            ok(res);
            const j = await res.json().catch(()=>({}));
            console.log('writeData result:', j);
          }

          // 3) getContentï¼ˆæ‹‰å‡ºæ‰€æœ‰åˆ†ç±»æ•°æ®ï¼‰
          console.log('ğŸ“¥ getContent ...');
          const all = {};
          {
            const res = await fetch(`${BASE}/getContent?date=${DATE}`);
            ok(res);
            const j = await res.json();
            // è¿‡æ»¤å‡ºå„ä¸ªåˆ†ç±»æ•°ç»„ï¼ˆå¿½ç•¥ message/date å­—æ®µï¼‰
            for (const [k,v] of Object.entries(j)) {
              if (Array.isArray(v)) all[k] = v;
            }
            console.log('got categories:', Object.keys(all));
          }

          // 4) æ„é€  selectedItemsï¼ˆå„ç±»åˆ«æœ€å¤šå–å‰ MAX_PER_TYPE æ¡ï¼‰
          console.log('ğŸ§© build selectedItems ...');
          const selectedItems = [];
          for (const [type, arr] of Object.entries(all)) {
            for (const it of (arr || []).slice(0, MAX_PER_TYPE)) {
              if (it && (it.id !== undefined && it.id !== null)) {
                selectedItems.push(`${type}:${it.id}`);
              }
            }
          }
          if (selectedItems.length === 0) throw new Error('No items to select â€“ writeData may have fetched nothing.');

          // 5) genAIContentï¼ˆç”Ÿæˆæ—¥æŠ¥ HTML é¡µé¢ï¼Œè§£æå…¶ä¸­çš„ markdownï¼‰
          console.log('ğŸ¤– genAIContent ...');
          let markdown = '';
          {
            const fd = form([
              ['date', DATE],
              ['selectedItems', selectedItems] // é‡å¤å­—æ®µ
            ]);
            const res = await fetchWithCookie(`${BASE}/genAIContent`, {
              method: 'POST',
              body: fd
            });
            ok(res);
            const html = await res.text();

            // ä»é¡µé¢é‡Œæå– textarea name="daily_summary_markdown" çš„å†…å®¹
            // ï¼ˆåŸä½œè€… generateGenAiPageHtml ä¼šå¸¦è¿™ä¸ªè¡¨å•ä»¥ä¾¿æäº¤ï¼‰
            const m = html.match(/<textarea[^>]*name=["']daily_summary_markdown["'][^>]*>([\s\S]*?)<\/textarea>/i);
            if (!m) {
              // å…œåº•ï¼šæå– AI æ—¥æŠ¥ main åŒºåŸŸï¼ˆå¯æŒ‰éœ€æ‰©å……ï¼‰
              throw new Error('Cannot find daily_summary_markdown textarea in genAIContent HTML.');
            }
            markdown = m[1]
              .replace(/&lt;/g,'<')
              .replace(/&gt;/g,'>')
              .replace(/&amp;/g,'&');
            if (!markdown.trim()) throw new Error('Empty markdown extracted from genAIContent.');
          }
          console.log(`âœ… genAIContent OK (length=${markdown.length})`);

          // 6) commitToGitHubï¼ˆæŠŠ markdown å†™å…¥ daily/DATE.mdï¼‰
          console.log('â¬†ï¸ commitToGitHub ...');
          {
            const fd = form([
              ['date', DATE],
              ['daily_summary_markdown', markdown]
            ]);
            const res = await fetchWithCookie(`${BASE}/commitToGitHub`, {
              method: 'POST',
              body: fd
            });
            ok(res);
            const j = await res.json().catch(()=>({}));
            console.log('commitToGitHub result:', j);
          }

          // 7) writeRssDataï¼ˆå°†è¯¥æ—¥å†…å®¹å†™å…¥ KVï¼Œä¾› RSS èšåˆï¼‰
          console.log('ğŸª„ writeRssData ...');
          {
            const res = await fetch(`${BASE}/writeRssData?date=${DATE}`, { redirect: 'follow' });
            ok(res);
            const j = await res.json().catch(()=>({}));
            console.log('writeRssData result:', j.title || j.report_date || 'OK');
          }

          // 8) ä¸‹è½½ RSS åˆ°æœ¬åœ°æ–‡ä»¶
          console.log('â¬‡ï¸ download RSS ...');
          {
            const res = await fetch(`${BASE}/rss?days=7`);
            ok(res);
            const xml = await res.text();
            const fs = await import('node:fs/promises');
            await fs.writeFile('rss.xml', xml, 'utf8');
          }

          console.log('ğŸ‰ All done for', DATE);
          EOF

      - name: Commit and push changes (rss.xml)
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          if [ -f "rss.xml" ]; then
            git add rss.xml
          fi

          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "docs: auto-build AI Daily ($(date -u))"
            git push
          fi

