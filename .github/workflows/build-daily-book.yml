name: Build Daily Journal

on:
  workflow_dispatch:    # 允许手动触发
  schedule:
    - cron: "0 1 * * *" # 每天 UTC 01:00 执行（北京时间上午 9 点）

jobs:
  build-book:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Archive old notes
        run: |
          echo "Archiving previous notes if needed..."
          mkdir -p archive
          # 可在此添加归档逻辑（目前跳过）

      - name: Trigger RSS Data Write
        env:
          WRITE_RSS_URL: ${{ secrets.WRITE_RSS_URL }}
        run: |
          echo "Triggering RSS Data Write via Cloudflare Worker..."
          TODAY=$(date +'%Y-%m-%d')
          echo "📅 Today is $TODAY"
          RESPONSE=$(curl -s -w "%{http_code}" -o response.json "${WRITE_RSS_URL}?date=${TODAY}")
          STATUS=$(tail -n1 <<< "$RESPONSE")
          if [ "$STATUS" != "200" ]; then
            echo "❌ RSS Data Write failed (HTTP $STATUS)"
            cat response.json
            exit 1
          fi
          echo "✅ RSS Data Write succeeded"
          cat response.json

      - name: Download RSS Feed
        env:
          RSS_FEED_URL: ${{ secrets.RSS_FEED_URL }}
        run: |
          echo "Downloading latest RSS feed..."
          curl -s -o rss.xml "${RSS_FEED_URL}?days=7"
          echo "✅ RSS Feed downloaded successfully"

      - name: Commit and push changes
        run: |
          echo "Committing generated files..."
          git add daily/ || echo "No daily directory found"
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git commit -m "Update daily report for $(date +'%Y-%m-%d')" || echo "No changes to commit"
          git push || echo "No changes pushed"

      - name: Complete job
        run: echo "🎉 Daily journal build process completed successfully."
